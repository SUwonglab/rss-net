---
title: "RSS-NET analysis of simulated GWAS summary statistics and B cell regulatory network"
author: "Xiang Zhu"
date: "2019-08-18"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

[`wtccc_bcell/`]: https://github.com/SUwonglab/rss-net/tree/master/examples/wtccc_bcell
[zenodo-wtcccbcell]: 

## Overview

Here we describe an end-to-end RSS-NET analysis of two synthetic datasets
that are simulated from real genotypes of 348965 genome-wide SNPs from
1458 individuals in the UK Blood Service Control Group
([Wellcome Trust Case Control Consortium, 2007](https://doi.org/10.1038/nature05911))
and a gene regulatory network inferred for B cells
[(ENCODE Project Consortium, 2012)](https://doi.org/10.1038/nature11247).
This example gives a quick view of how RSS-NET works.

To reproduce results of this example,
please use scripts in the directory [`wtccc_bcell/`][],
and follow the step-by-step guide below.
Before running any script in [`wtccc_bcell/`][],
please [install](setup.html) RSS-NET.

With the software installed and the input data downloaded,
one should be able to run this example by simply typing the following line in shell:

```{r, eval=FALSE, engine='zsh'}
$ sbatch run_simulation.sbatch
```

If a different directory is used to store the software, input data
and/or output data, please modify file paths in the given scripts accordingly.

## Step-by-step illustration

### Download data files

All data files required to run this example are freely available at Zenodo
[![DOI]()][zenodo-wtcccbcell].
Please contact me (`xiangzhu[at]stanford.edu`)
if you have any trouble accessing these files.
After a complete download, you should see the following files.

```{r, eval=FALSE, engine='zsh'}
add tree
```

To help readers confirm if they use the same files as we do,
we report 128-bit MD5 hashes of all files in `wtccc_bcell_data.md5`.

To help readers confirm if they can reproduce results of this example,
we also provide the results (`wtccc_bcell_results.zip`) in the same Zenodo deposit.

For simplicity and generality,
we introduce the following short-hand notations.

```matlab
gwas = 'WTCCC';
net  = 'Primary_B_cells_from_peripheral_blood'; 
```

#### 1. `m*_data.mat`: simulated GWAS summary statistics and reference LD estimates

Here we simulate two synthetic datasets from WTCCC genotypes and B cell network:
one (`m0_data.mat`) based on RSS-NET baseline model $M_0$,
and the other (`m1_data.mat`) based on RSS-NET enrichment model $M_1$.
We match `m*_data.mat` by the number of trait-associated SNPs and
the proportion of phenotypic variation explained by all SNPs.
By this desgin, `m*_data.mat` have the same amount of genetic signals,
and they only differ in how genetic signals are distributed:
for the enrichment dataset `m1_data.mat`
genetic associations are enriched in the B cell network;
for the baseline dataset `m0_data.mat`
genetic associations are randomly distributed across the genome.

```{r, eval=FALSE, engine='zsh'}
$ md5sum m*_data.mat
5d652796b4cc358843920b1edf2819fc  m0_data.mat
996eae1410f89607f1debefb31ec7811  m1_data.mat

$ du -sh m*_data.mat
3.0G	m0_data.mat
3.0G	m1_data.mat
```

Let's look at the contents of `m*_data.mat`.

```matlab
>> sumstat=matfile('m0_data.mat'); 
>> sumstat
  matlab.io.MatFile
  Properties:
      Properties.Source: 'm0_data.mat'
    Properties.Writable: false                                                  
                  SiRiS: [22x1 cell]                                            
                betahat: [22x1 cell]                                            
                    chr: [22x1 cell]                                            
                    pos: [22x1 cell]                                            
                     se: [22x1 cell]
```

GWAS summary statistics and LD estimates are stored as
[cell arrays](https://www.mathworks.com/help/matlab/cell-arrays.html).
RSS-NET only uses the following variables:

- `betahat{j,1}`, single-SNP effect size estimates of all SNPs on chromosome `j`;
- `se{j,1}`, standard errors of `betahat{j, 1}`;
- `chr{j,1}` and `pos{j, 1}`, physical positions of these SNPs (GRCh37 build);
- `SiRiS{j,1}`, a [sparse matrix](https://www.mathworks.com/help/matlab/sparse-matrices.html),
defined as `repmat((1./se),1,p) .* R .* repmat((1./se)',p,1)`,
where `R` is the estimated LD matrix of these `p` SNPs.

#### 2. `${gwas}_snp2gene.mat`: physical distance between SNPs and genes

This file contains the physical distance between
each GWAS SNP and each protein-coding gene, within 1 Mb.
This file corresponds to ${\bf G}_j$ in the RSS-NET model.

```{r, eval=FALSE, engine='zsh'}
$ md5sum WTCCC_snp2gene.mat 
50da1887601df3a0914380e2ea9b1be7  WTCCC_snp2gene.mat

$ du -sh WTCCC_snp2gene.mat
645M	WTCCC_snp2gene.mat
```

In this example, there are 18334 genes and 348965 SNPs.

```matlab
>> snp2gene=matfile('WTCCC_snp2gene.mat');
>> snp2gene
  matlab.io.MatFile
  Properties:
      Properties.Source: 'WTCCC_snp2gene.mat'
    Properties.Writable: false                                                         
                    chr: [348965x1   double]                                           
                  colid: [41897736x1 int32]                                            
             ncbi35_pos: [348965x1   int32]                                            
                numgene: [1x1        int32]                                            
                 numsnp: [1x1        int32]                                            
                    pos: [348965x1   int32]                                            
                  rowid: [41897736x1 int32]                                            
                    val: [41897736x1 double]                                           

>> [snp2gene.numgene snp2gene.numsnp]
    18334   348965
```

The SNP-to-gene distance information is captured
by a three-column matrix `[colid rowid val]`.
For example, the distance between gene `7` and SNP `161` is `2855196` bps. 

```matlab
>> colid=snp2gene.colid; rowid=snp2gene.rowid; val=snp2gene.val;
>> [colid(6688) rowid(6688) val(6688)]
         7       161   2855196
```
